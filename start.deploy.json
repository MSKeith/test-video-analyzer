{
    "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "metadata": {
        "description": "This template is orchestrates a deployment of Azure Video Analyzer and the supporting resources needed for running most official samples. It is a subscription level deployment and uses both nested and linked templates for scope and modularity."
    },
    "parameters": {
        "resourceGroup": {
            "type": "string",
            "defaultValue": "ava-sample-deployment",
            "metadata": {
                "description": "The name of the resource group for deploying new resources."
            }
        },
        "scenario": {
            "type": "string",
            "defaultValue": "general-sample-setup",
            "allowedValues": [ "general-sample-setup" ],
            "metadata": {
                "description": "This template supports a set of scenarios with different configurations. For details on the scenarios please see the documentation."
            }
        },
        "simulatedEdgeDeviceAdminUsername": {
            "metadata": {
                "description": "The username for accesing the VM acting as the edge device."
            },
            "defaultValue": "avaadmin",
            "type": "string"
        },
        "simulatedEdgeDeviceAdminPassword": {
            "type": "securestring",
            "metadata": {
                "description": "The password for accesing the VM acting as the edge device.",
                "todo": "Provide an option to use SSH, this is already present in the linked template."
            }
        },
        "useBastionHost": {
            "metadata": {
                "description": "If true, the template will deploy a bastion host for connecting to the simulated edge device."
            },
            "defaultValue": false,
            "type": "bool"
        },
        "useExistingEdgeDevice": {
            "metadata": {
                "description": "If true, this deployment will override the modules that are currently deployed on the specified device."
            },
            "defaultValue": false,
            "type": "bool"
        },
        "existingHubName": {
            "metadata": {
                "description": "An (optional) existing IoT Hub to use instead of creating a new one."
            },
            "defaultValue": "",
            "type": "string"
        },
        "existingHubNameResourceGroup": {
            "metadata": {
                "description": "The resource group name of the existing IoT Hub if specified."
            },
            "defaultValue": "",
            "type": "string"
        },
        "existingDeviceName": {
            "metadata": {
                "description": "An (optional) existing edge device to use instead of creating a simulated device. It is expected to already be registered with the specified existing hub."
            },
            "defaultValue": "",
            "type": "string"
        },
        "resourceTags": {
            "type": "object",
            "defaultValue": {
                "sample": "azure-video-analyzer"
            }
        },
        "namePrefix": {
            "metadata": {
                "description": "Used to qualify the names of all of the resources created in this template."
            },
            "defaultValue": "avasample",
            "type": "string",
            "minLength": 3,
            "maxLength": 11
        },
        "baseTime": {
            "type": "string",
            "defaultValue": "[utcNow('u')]",
            "metadata": {
                "description": "This parameter is also used as the forceUpdateTag for deployment scripts in this template. A dynamic value ensures that scripts are executed each time."
            }
        }
    },
    "variables": {
        "_artifactsLocation": "https://github.com/Azure/video-analyzer/setup/raw/",
        "managedIdentityName": "[concat(parameters('namePrefix'),'-deployment-identity-',uniqueString(parameters('resourceGroup')))]",
        "managedIdentityId": "[concat(subscription().id,'/resourceGroups/',parameters('resourceGroup'),'/providers/Microsoft.ManagedIdentity/userAssignedIdentities/', variables('managedIdentityName'))]",
        "simulatedDeviceName": "[concat(parameters('namePrefix'),'-iot-edge-device')]",
        "deviceName": "[if(parameters('useExistingEdgeDevice'),parameters('existingDeviceName'),variables('simulatedDeviceName'))]"

    },
    "resources": [
        {
            "type": "Microsoft.Resources/resourceGroups",
            "apiVersion": "2020-06-01",
            "name": "[parameters('resourceGroup')]",
            "comments": "The primary resource group that will be used for new resources.",
            "location": "[deployment().location]",
            "properties": {},
            "tags": "[parameters('resourceTags')]"
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "name": "deploy-managed-identity",
            "comments": "This is a nested deployment into the main resource group. The managed identity is necessary for running script during deployment. It is not needed for operating Video Analyzer.",
            "resourceGroup": "[parameters('resourceGroup')]",
            "dependsOn": [
                "[parameters('resourceGroup')]"
            ],
            "properties": {
                "mode": "Incremental",
                "expressionEvaluationOptions": {
                    "scope": "Inner"
                },
                "parameters": {
                    "managedIdentityName": {
                        "value": "[variables('managedIdentityName')]"
                    }
                },
                "template": {
                    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "managedIdentityName": {
                            "type": "string"
                        }
                    },
                    "variables": {
                        "roleAssignmentName": "[guid(concat(resourceGroup().id),parameters('managedIdentityName'), 'contributor')]",
                        "roleDefinitionId": "[concat(resourceGroup().id, '/providers/Microsoft.Authorization/roleDefinitions/', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]"
                    },
                    "resources": [
                        {
                            "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
                            "name": "[parameters('managedIdentityName')]",
                            "apiVersion": "2018-11-30",
                            "location": "[resourceGroup().location]"
                        },
                        {
                            "type": "Microsoft.Authorization/roleAssignments",
                            "apiVersion": "2018-09-01-preview",
                            "name": "[variables('roleAssignmentName')]",
                            "properties": {
                                "roleDefinitionId": "[variables('roleDefinitionId')]",
                                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities',parameters('managedIdentityName')), '2018-11-30').principalId]",
                                "scope": "[resourceGroup().id]",
                                "principalType": "ServicePrincipal"
                            }
                        }
                    ],
                    "outputs": {
                        "managedIdentity": {
                            "type": "object",
                            "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities',parameters('managedIdentityName')), '2018-11-30')]"
                        }
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "name": "deploy-container-registry",
            "comments": "",
            "resourceGroup": "[parameters('resourceGroup')]",
            "dependsOn": [
                "[parameters('resourceGroup')]"
            ],
            "properties": {
                "mode": "Incremental",
                "expressionEvaluationOptions": {
                    "scope": "Inner"
                },
                "parameters": {
                    "namePrefix": {
                        "value": "[parameters('namePrefix')]"
                    },
                    "resourceTags": {
                        "value": "[parameters('resourceTags')]"
                    }
                },
                "template": {
                    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "namePrefix": {
                            "type": "string"
                        },
                        "resourceTags": {
                            "type": "object"
                        }
                    },
                    "variables": {
                        "registryName": "[concat(parameters('namePrefix'),'registry',uniqueString(resourceGroup().name))]"
                    },
                    "resources": [
                        {
                            "type": "Microsoft.ContainerRegistry/registries",
                            "comments": "The basic sample scenarios do not require a registry. However, this will be used for more advanced scenarios.",
                            "apiVersion": "2019-05-01",
                            "name": "[variables('registryName')]",
                            "location": "[resourceGroup().location]",
                            "sku": {
                                "name": "Basic"
                            },
                            "properties": {
                                "adminUserEnabled": true
                            },
                            "tags": "[parameters('resourceTags')]"
                        }
                    ],
                    "outputs": {
                        "registry_credentials": {
                            "type": "object",
                            "value": "[listCredentials(resourceId('Microsoft.ContainerRegistry/registries', variables('registryName')),'2019-05-01')]"
                        }
                    }
                }
            }
        },
        {
            "condition": "[and(parameters('useExistingEdgeDevice'),not(equals(parameters('existingHubNameResourceGroup'),parameters('resourceGroup'))))]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "name": "assign-role-for-existing-resource-group",
            "comments": "The managed identity needs access to the existing resource group that contains the IoT Hub. If the resource group doesn't exist the deployment will fail.",
            "dependsOn": [
                "deploy-managed-identity"
            ],
            "resourceGroup": "[parameters('existingHubNameResourceGroup')]",
            "properties": {
                "mode": "Incremental",
                "expressionEvaluationOptions": {
                    "scope": "Inner"
                },
                "parameters": {
                    "principalId": {
                        "value": "[reference('deploy-managed-identity').outputs.managedIdentity.value.principalId]"
                    }
                },
                "template": {
                    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "principalId": {
                            "type": "string"
                        }
                    },
                    "variables": {
                        "roleAssignmentName": "[guid(concat(resourceGroup().id), parameters('principalId'), 'contributor')]",
                        "roleDefinitionId": "[concat(resourceGroup().id, '/providers/Microsoft.Authorization/roleDefinitions/', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]"
                    },
                    "resources": [
                        {
                            "type": "Microsoft.Authorization/roleAssignments",
                            "apiVersion": "2018-09-01-preview",
                            "name": "[variables('roleAssignmentName')]",
                            "comments": "This role assignment is only needed when the IoT Hub is in a different resource group (to deploy the module manifest).",
                            "properties": {
                                "roleDefinitionId": "[variables('roleDefinitionId')]",
                                "principalId": "[parameters('principalId')]",
                                "scope": "[resourceGroup().id]",
                                "principalType": "ServicePrincipal"
                            }
                        }
                    ],
                    "outputs": {}
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "name": "deploy-video-analyzer-resources",
            "comments": "Deploys the core resources for Video Analyzer",
            "resourceGroup": "[parameters('resourceGroup')]",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/resourceGroups',parameters('resourceGroup'))]"
            ],
            "properties": {
                "templateLink": {
                    "uri": "[uri(variables('_artifactsLocation'),'video-analyzer.deploy.json')]"
                },
                "mode": "Incremental",
                "parameters": {
                    "namePrefix": {
                        "value": "[parameters('namePrefix')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "name": "deploy-iot-resources",
            "comments": "Deploys the supporting IoT resources. There is conditional logic in this template to handle existing resources.",
            "resourceGroup": "[parameters('resourceGroup')]",
            "dependsOn": [
                "[parameters('resourceGroup')]"
            ],
            "properties": {
                "templateLink": {
                    "uri": "[uri(variables('_artifactsLocation'),'iot.deploy.json')]"
                },
                "mode": "Incremental",
                "parameters": {
                    "namePrefix": {
                        "value": "[parameters('namePrefix')]"
                    },
                    "hubName": {
                        "value": "[if(parameters('useExistingEdgeDevice'),parameters('existingHubName'),'')]"
                    },
                    "hubResourceGroup": {
                        "value": "[if(parameters('useExistingEdgeDevice'),parameters('existingHubNameResourceGroup'),'')]"
                    },
                    "resourceTags": {
                        "value": "[parameters('resourceTags')]"
                    }
                }
            }
        },
        {
            "condition": "[not(parameters('useExistingEdgeDevice'))]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "name": "register-edge-device-on-hub",
            "comments": "This nested deployment uses a deployment script to register an edge device on the IoT Hub.",
            "dependsOn": [
                "deploy-managed-identity",
                "deploy-iot-resources"
            ],
            "resourceGroup": "[parameters('resourceGroup')]",
            "properties": {
                "mode": "Incremental",
                "expressionEvaluationOptions": {
                    "scope": "Inner"
                },
                "parameters": {
                    "_artifactsLocation": { "value": "[variables('_artifactsLocation')]" },
                    "baseTime": { "value": "[parameters('baseTime')]" },
                    "managedIdentityId": { "value": "[variables('managedIdentityId')]" },
                    "hubName": { "value": "[reference('deploy-iot-resources').outputs.hubName.value]" },
                    "simulatedDeviceName": { "value": "[variables('simulatedDeviceName')]" },
                    "resourceTags": { "value": "[parameters('resourceTags')]" }
                },
                "template": {
                    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "_artifactsLocation": { "type": "string" },
                        "baseTime": { "type": "string" },
                        "managedIdentityId": { "type": "string" },
                        "hubName": { "type": "string" },
                        "simulatedDeviceName": { "type": "string" },
                        "resourceTags": { "type": "object" }
                    },
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.Resources/deploymentScripts",
                            "apiVersion": "2019-10-01-preview",
                            "name": "execute-iot-edge-setup.sh",
                            "location": "[resourceGroup().location]",
                            "kind": "AzureCLI",
                            "identity": {
                                "type": "UserAssigned",
                                "userAssignedIdentities": {
                                    "[parameters('managedIdentityId')]": {}
                                }
                            },
                            "properties": {
                                "forceUpdateTag": "[parameters('baseTime')]",
                                "azCliVersion": "2.20.0",
                                "primaryScriptUri": "[uri(parameters('_artifactsLocation'),'iot-edge-setup.sh')]",
                                "environmentVariables": [
                                    {
                                        "name": "IOTHUB",
                                        "value": "[parameters('hubName')]"
                                    },
                                    {
                                        "name": "EDGE_DEVICE",
                                        "value": "[parameters('simulatedDeviceName')]"
                                    }
                                ],
                                "retentionInterval": "P1D",
                                "timeout": "PT15M",
                                "cleanupPreference": "OnSuccess"
                            },
                            "tags": "[parameters('resourceTags')]"
                        }
                    ],
                    "outputs": {
                        "scriptOutputs": {
                            "type": "object",
                            "value": "[reference('execute-iot-edge-setup.sh','2019-10-01-preview').outputs]"
                        },
                        "comments": {
                            "type": "string",
                            "value": "We added the `scriptOutputs` as a workaround. For an unknown reason, we could not access the `deviceConnectionString` directly."
                        }
                    }
                }
            }
        },
        {
            "condition": "[not(parameters('useExistingEdgeDevice'))]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "name": "deploy-simulated-edge-device",
            "dependsOn": [
                "deploy-iot-resources",
                "register-edge-device-on-hub",
                "[parameters('resourceGroup')]"
            ],
            "resourceGroup": "[parameters('resourceGroup')]",
            "properties": {
                "mode": "Incremental",
                "expressionEvaluationOptions": {
                    "scope": "Inner"
                },
                "parameters": {
                    "_artifactsLocation": {
                        "value": "[variables('_artifactsLocation')]"
                    },
                    "vmName": {
                        "value": "[variables('simulatedDeviceName')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('simulatedEdgeDeviceAdminUsername')]"
                    },
                    "adminPasswordOrKey": {
                        "value": "[parameters('simulatedEdgeDeviceAdminPassword')]"
                    },
                    "edgeDeviceConnectionString": {
                        "value": "[if(parameters('useExistingEdgeDevice'),'',reference('register-edge-device-on-hub','2020-10-01').outputs.scriptOutputs.value.deviceConnectionString)]"
                    },
                    "useBastion": {
                        "value": "[parameters('useBastionHost')]"
                    }
                },
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "_artifactsLocation": {
                            "type": "string",
                            "metadata": {
                                "description": "The remote location for resolving supporting files."
                            }
                        },
                        "useBastion": {
                            "type": "bool",
                            "defaultValue": false,
                            "metadata": {
                                "description": "If true, the VM acting as the simulated edge device will only be accessible using a Bastion."
                            }
                        },
                        "edgeDeviceConnectionString": {
                            "type": "string",
                            "metadata": {
                                "description": "The connection string that will be used to register the device with the IoT Hub."
                            }
                        },
                        "vmName": {
                            "type": "string",
                            "metadata": {
                                "description": "The name of the VM hosting the Azure IoT Edge runtime."
                            }
                        },
                        "vmSize": {
                            "type": "string",
                            "defaultValue": "Standard_DS3_v2",
                            "metadata": {
                                "description": "The size of the VM"
                            }
                        },
                        "authenticationType": {
                            "type": "string",
                            "defaultValue": "password",
                            "allowedValues": [
                                "sshPublicKey",
                                "password"
                            ],
                            "metadata": {
                                "description": "Type of authentication to use on the Virtual Machine. SSH key is recommended."
                            }
                        },
                        "adminPasswordOrKey": {
                            "type": "securestring",
                            "metadata": {
                                "description": "SSH Key or password for the VM. SSH key is recommended."
                            }
                        },
                        "adminUsername": {
                            "metadata": {
                                "description": "The username for accesing the edge device."
                            },
                            "defaultValue": "avaadmin",
                            "type": "string"
                        },
                        "ubuntuOSVersion": {
                            "type": "string",
                            "defaultValue": "18.04-LTS",
                            "allowedValues": [
                                "18.04-LTS"
                            ],
                            "metadata": {
                                "description": "The Ubuntu version for the VM. This should be a version supported by the IoT Edge runtime."
                            }
                        },
                        "resourceTags": {
                            "type": "object",
                            "defaultValue": {
                                "sample": "azure-video-analyzer"
                            }
                        }
                    },
                    "variables": {
                        "dcs": "[parameters('edgeDeviceConnectionString')]",
                        "nsgName": "[concat(parameters('vmName'),'-nsg-allow-ssh')]",
                        "bastionName": "[concat(parameters('vmName'),'-bastion')]",
                        "vnetName": "[concat(parameters('vmName'),'-vnet')]",
                        "pipName": "[concat(parameters('vmName'),'-pip')]",
                        "nicName": "[concat(parameters('vmName'),if(parameters('useBastion'),'-bastion-nic','-nic'))]",
                        "linuxConfiguration": {
                            "disablePasswordAuthentication": true,
                            "ssh": {
                                "publicKeys": [
                                    {
                                        "path": "[concat('/home/',parameters('adminUsername'),'/.ssh/authorized_keys')]",
                                        "keyData": "[parameters('adminPasswordOrKey')]"
                                    }
                                ]
                            }
                        },
                        "customData": "[base64(concat('#cloud-config\n\napt:\n  preserve_sources_list: true\n  sources:\n    msft.list:\n      source: \"deb https://packages.microsoft.com/ubuntu/18.04/multiarch/prod bionic main\"\n      key: |\n        -----BEGIN PGP PUBLIC KEY BLOCK-----\n        Version: GnuPG v1.4.7 (GNU/Linux)\n\n        mQENBFYxWIwBCADAKoZhZlJxGNGWzqV+1OG1xiQeoowKhssGAKvd+buXCGISZJwT\n        LXZqIcIiLP7pqdcZWtE9bSc7yBY2MalDp9Liu0KekywQ6VVX1T72NPf5Ev6x6DLV\n        7aVWsCzUAF+eb7DC9fPuFLEdxmOEYoPjzrQ7cCnSV4JQxAqhU4T6OjbvRazGl3ag\n        OeizPXmRljMtUUttHQZnRhtlzkmwIrUivbfFPD+fEoHJ1+uIdfOzZX8/oKHKLe2j\n        H632kvsNzJFlROVvGLYAk2WRcLu+RjjggixhwiB+Mu/A8Tf4V6b+YppS44q8EvVr\n        M+QvY7LNSOffSO6Slsy9oisGTdfE39nC7pVRABEBAAG0N01pY3Jvc29mdCAoUmVs\n        ZWFzZSBzaWduaW5nKSA8Z3Bnc2VjdXJpdHlAbWljcm9zb2Z0LmNvbT6JATUEEwEC\n        AB8FAlYxWIwCGwMGCwkIBwMCBBUCCAMDFgIBAh4BAheAAAoJEOs+lK2+EinPGpsH\n        /32vKy29Hg51H9dfFJMx0/a/F+5vKeCeVqimvyTM04C+XENNuSbYZ3eRPHGHFLqe\n        MNGxsfb7C7ZxEeW7J/vSzRgHxm7ZvESisUYRFq2sgkJ+HFERNrqfci45bdhmrUsy\n        7SWw9ybxdFOkuQoyKD3tBmiGfONQMlBaOMWdAsic965rvJsd5zYaZZFI1UwTkFXV\n        KJt3bp3Ngn1vEYXwijGTa+FXz6GLHueJwF0I7ug34DgUkAFvAs8Hacr2DRYxL5RJ\n        XdNgj4Jd2/g6T9InmWT0hASljur+dJnzNiNCkbn9KbX7J/qK1IbR8y560yRmFsU+\n        NdCFTW7wY0Fb1fWJ+/KTsC4=\n        =J6gs\n        -----END PGP PUBLIC KEY BLOCK----- \npackages:\n  - moby-cli\n  - libiothsm-std\n  - moby-engine\nruncmd:\n  - |\n      set -x\n      (\n        # Wait for docker daemon to start\n        while [ $(ps -ef | grep -v grep | grep docker | wc -l) -le 0 ]; do \n          sleep 3\n        done\n\n        # Prevent iotedge from starting before the device connection string is set in config.yaml\n        sudo ln -s /dev/null /etc/systemd/system/iotedge.service\n        apt install iotedge\n        sed -i \"s#\\(device_connection_string: \\).*#\\1\\\"', variables('dcs'), '\\\"#g\" /etc/iotedge/config.yaml \n        systemctl unmask iotedge\n        systemctl start iotedge\n      sudo bash -c \"$(curl -sL ', parameters('_artifactsLocation'), 'prepare-device.sh)\"\n      ) &\n'))]"
                    },
                    "resources": [
                        {
                            "type": "Microsoft.Network/networkSecurityGroups",
                            "apiVersion": "2020-08-01",
                            "name": "[variables('nsgName')]",
                            "location": "[resourceGroup().location]",
                            "properties": {
                                "securityRules": [
                                    {
                                        "name": "allow-ssh",
                                        "properties": {
                                            "protocol": "Tcp",
                                            "access": "Allow",
                                            "direction": "Inbound",
                                            "sourcePortRange": "*",
                                            "sourceAddressPrefix": "*",
                                            "destinationPortRange": "22",
                                            "destinationAddressPrefix": "*",
                                            "priority": 100
                                        }
                                    }
                                ]
                            },
                            "tags": "[parameters('resourceTags')]"
                        },
                        {
                            "type": "Microsoft.Network/publicIpAddresses",
                            "comments": "This is the public IP address to connect to the VM (or to the bastion host).",
                            "apiVersion": "2019-06-01",
                            "name": "[variables('pipName')]",
                            "location": "[resourceGroup().location]",
                            "sku": {
                                "name": "Standard"
                            },
                            "properties": {
                                "publicIPAllocationMethod": "Static"
                            },
                            "tags": "[parameters('resourceTags')]"
                        },
                        {
                            "condition": "[parameters('useBastion')]",
                            "type": "Microsoft.Network/networkInterfaces",
                            "comments": "If we are using a bastion host, this nic will be configured on the VM.",
                            "apiVersion": "2020-08-01",
                            "name": "[concat(parameters('vmName'),'-bastion-nic')]",
                            "location": "[resourceGroup().location]",
                            "dependsOn": [
                                "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]"
                            ],
                            "properties": {
                                "ipConfigurations": [
                                    {
                                        "name": "private-bastion-only",
                                        "properties": {
                                            "privateIPAddress": "10.0.0.4",
                                            "privateIPAllocationMethod": "Dynamic",
                                            "subnet": {
                                                "id": "[concat(resourceId('Microsoft.Network/virtualNetworks', variables('vnetName')), '/subnets/default')]"
                                            },
                                            "primary": true,
                                            "privateIPAddressVersion": "IPv4"
                                        }

                                    }
                                ]
                            }
                        },
                        {
                            "condition": "[not(parameters('useBastion'))]",
                            "type": "Microsoft.Network/networkInterfaces",
                            "comments": "If we are not using a bastion host and instead we are connecting directly to the VM, then we use this nic.",
                            "apiVersion": "2020-08-01",
                            "name": "[concat(parameters('vmName'),'-nic')]",
                            "location": "[resourceGroup().location]",
                            "dependsOn": [
                                "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]",
                                "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsgName'))]"
                            ],
                            "properties": {
                                "ipConfigurations": [
                                    {
                                        "name": "public-ip-for-vm",
                                        "properties": {
                                            "privateIPAddress": "10.0.0.4",
                                            "privateIPAllocationMethod": "Dynamic",
                                            "subnet": {
                                                "id": "[concat(resourceId('Microsoft.Network/virtualNetworks', variables('vnetName')), '/subnets/default')]"
                                            },
                                            "primary": true,
                                            "privateIPAddressVersion": "IPv4",
                                            "publicIPAddress": {
                                                "id": "[resourceId(resourceGroup().name, 'Microsoft.Network/publicIpAddresses', variables('pipName'))]"
                                            }
                                        }
                                    }
                                ],
                                "networkSecurityGroup": {
                                    "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsgName'))]"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.Compute/virtualMachines",
                            "apiVersion": "2020-06-01",
                            "name": "[parameters('vmName')]",
                            "location": "[resourceGroup().location]",
                            "dependsOn": [
                                "[resourceId('Microsoft.Network/networkInterfaces/', variables('nicName'))]"
                            ],
                            "properties": {
                                "hardwareProfile": {
                                    "vmSize": "[parameters('vmSize')]"
                                },
                                "storageProfile": {
                                    "osDisk": {
                                        "createOption": "fromImage",
                                        "managedDisk": {
                                            "storageAccountType": "Standard_LRS"
                                        }
                                    },
                                    "imageReference": {
                                        "publisher": "Canonical",
                                        "offer": "UbuntuServer",
                                        "sku": "[parameters('ubuntuOSVersion')]",
                                        "version": "latest"
                                    }
                                },
                                "networkProfile": {
                                    "networkInterfaces": [
                                        {
                                            "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('nicName'))]"
                                        }
                                    ]
                                },
                                "osProfile": {
                                    "computerName": "[parameters('vmName')]",
                                    "adminUsername": "[parameters('adminUsername')]",
                                    "adminPassword": "[parameters('adminPasswordOrKey')]",
                                    "linuxConfiguration": "[if(equals(parameters('authenticationType'), 'password'), json('null'), variables('linuxConfiguration'))]",
                                    "customData": "[variables('customData')]"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.Network/virtualNetworks",
                            "comments": "This vnet will host the IoT Edge device. The configuration in this template is to support an Azure Bastion connection to the VM.",
                            "apiVersion": "2019-06-01",
                            "name": "[variables('vnetName')]",
                            "location": "[resourceGroup().location]",
                            "properties": {
                                "addressSpace": {
                                    "addressPrefixes": [
                                        "10.0.0.0/26"
                                    ]
                                },
                                "subnets": [
                                    {
                                        "name": "default",
                                        "properties": {
                                            "addressPrefix": "10.0.0.0/27"
                                        }
                                    },
                                    {
                                        "name": "AzureBastionSubnet",
                                        "properties": {
                                            "addressPrefix": "10.0.0.32/27"
                                        }
                                    }
                                ]
                            },
                            "tags": "[parameters('resourceTags')]"
                        },

                        {
                            "condition": "[parameters('useBastion')]",
                            "type": "Microsoft.Network/bastionHosts",
                            "apiVersion": "2019-06-01",
                            "name": "[variables('bastionName')]",
                            "comments": "Azure Bastion provides a secure mechanism for connecting to the IoT Edge VM. It is accessible in the portal on the VM's blade by clicking 'Connect'.",
                            "location": "[resourceGroup().location]",
                            "dependsOn": [
                                "[variables('pipName')]",
                                "[variables('vnetName')]"
                            ],
                            "properties": {
                                "ipConfigurations": [
                                    {
                                        "name": "IpConf",
                                        "properties": {
                                            "subnet": {
                                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnetName'), 'AzureBastionSubnet')]"
                                            },
                                            "publicIPAddress": {
                                                "id": "[resourceId('Microsoft.Network/publicIpAddresses', variables('pipName'))]"
                                            }
                                        }
                                    }
                                ]
                            },
                            "tags": "[parameters('resourceTags')]"
                        }
                    ],
                    "outputs": {
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "name": "deploy-and-configure-modules",
            "comments": "This nested deployment uses a deployment script to set modules on the specified edge device.",
            "dependsOn": [
                "deploy-video-analyzer-resources",
                "deploy-simulated-edge-device",
                "[parameters('resourceGroup')]",
                "deploy-container-registry"
            ],
            "resourceGroup": "[parameters('resourceGroup')]",
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.Resources/deploymentScripts",
                            "apiVersion": "2020-10-01",
                            "name": "execute-deploy-modules.sh",
                            "location": "[deployment().location]",
                            "kind": "AzureCLI",
                            "identity": {
                                "type": "UserAssigned",
                                "userAssignedIdentities": {
                                    "[variables('managedIdentityId')]": {}
                                }
                            },
                            "comments": "The values for VIDEO_OUTPUT_FOLDER_ON_DEVICE, VIDEO_INPUT_FOLDER_ON_DEVICE and APPDATA_FOLDER_ON_DEVICE must match the hardcoded values in prepare-device.sh.",
                            "properties": {
                                "forceUpdateTag": "[parameters('baseTime')]",
                                "azCliVersion": "2.20.0",
                                "primaryScriptUri": "[uri(variables('_artifactsLocation'),'deploy-modules.sh')]",
                                "supportingScriptUris": [
                                    "[uri(variables('_artifactsLocation'),concat(parameters('scenario'),'.modules.json'))]"
                                ],
                                "environmentVariables": [
                                    {
                                        "name": "DEPLOYMENT_MANIFEST_TEMPLATE_URL",
                                        "value": "[uri(variables('_artifactsLocation'),concat(parameters('scenario'),'.modules.json'))]"
                                    },
                                    {
                                        "name": "PROVISIONING_TOKEN",
                                        "value": "[reference('deploy-video-analyzer-resources').outputs.provisioningToken.value]"
                                    },
                                    {
                                        "name": "HUB_NAME",
                                        "value": "[reference('deploy-iot-resources').outputs.hubName.value]"
                                    },
                                    {
                                        "name": "DEVICE_ID",
                                        "value": "[variables('deviceName')]"
                                    },
                                    {
                                        "name": "VIDEO_INPUT_FOLDER_ON_DEVICE",
                                        "value": "/home/localedgeuser/samples/input"
                                    },
                                    {
                                        "name": "VIDEO_OUTPUT_FOLDER_ON_DEVICE",
                                        "value": "/var/media/"
                                    },
                                    {
                                        "name": "APPDATA_FOLDER_ON_DEVICE",
                                        "value": "/var/lib/videoanalyzer/"
                                    },
                                    {
                                        "name": "AZURE_STORAGE_ACCOUNT",
                                        "value": "[reference('deploy-video-analyzer-resources').outputs.storageAccountName.value]"
                                    },
                                    {
                                        "name": "RESOURCE_GROUP",
                                        "value": "[parameters('resourceGroup')]"
                                    },
                                    {
                                        "name": "SUBSCRIPTION_ID",
                                        "value": "[subscription().subscriptionId]"
                                    },
                                    {
                                        "name": "IOT_HUB_CONNECTION_STRING",
                                        "value": "[reference('deploy-iot-resources').outputs.connectionString.value]"
                                    },
                                    {
                                        "name": "IOT_EDGE_MODULE_NAME",
                                        "value": "[reference('deploy-video-analyzer-resources').outputs.edgeModuleName.value]"
                                    },
                                    {
                                        "name": "REGISTRY_USER_NAME",
                                        "value": "[reference('deploy-container-registry').outputs.registry_credentials.value.username]"
                                    },
                                    {
                                        "name": "REGISTRY_PASSWORD",
                                        "value": "[reference('deploy-container-registry').outputs.registry_credentials.value.passwords[0].value]"
                                    }
                                ],
                                "retentionInterval": "P1D",
                                "timeout": "PT15M",
                                "cleanupPreference": "OnSuccess"
                            },
                            "tags": "[parameters('resourceTags')]"
                        }
                    ],
                    "outputs": {}
                }
            }
        }
    ],
    "outputs": {
        "app-settings": {
            "type": "object",
            "value": {
                "iotHubConnectionString": "[reference('deploy-iot-resources').outputs.connectionString.value]",
                "deviceId": "[variables('deviceName')]",
                "moduleId": "[reference('deploy-video-analyzer-resources').outputs.edgeModuleName.value]"
            }
        }
    }
}